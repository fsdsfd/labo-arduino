#include <Wire.h>
#include <LiquidCrystal_I2C.h>

#define trigPin 6 //o cualquiera
#define echoPin 7 //o cualquiera
#define ledPin 13 //o cualquiera

LiquidCrystal_I2C lcd(0x27, 16, 2);

long duracion;
int distancia;
int puntaje = 0;
bool ledOn = false;
unsigned long ledStartTime = 0;
int topoCount = 0;

void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(ledPin, OUTPUT);

  Serial.begin(9600);
  randomSeed(analogRead(0));

  lcd.init();          
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("Atrapa al topo");
  lcd.setCursor(0, 1);
  lcd.print("Listo para jugar!");
  delay(2000);
  lcd.clear();
}

void loop() {
  if (topoCount >= 3) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Juego terminado!");
    lcd.setCursor(0, 1);
    lcd.print("Puntaje: ");
    lcd.print(puntaje);
    while (true); // Termina el juego
  }

  if (!ledOn) {
    int waitTime = random(1000, 3000); // entre 1 y 3 segundos
    delay(waitTime);
    digitalWrite(ledPin, HIGH);
    ledOn = true;
    ledStartTime = millis();

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Topo aparecio!");
  }

  // Medir distancia
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  duracion = pulseIn(echoPin, HIGH);
  distancia = duracion * 0.034 / 2;

  if (ledOn && distance < 10) {
    digitalWrite(ledPin, LOW);
    ledOn = false;
    puntaje += 2;
    topoCount++;

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Â¡Le diste!");
    lcd.setCursor(0, 1);
    lcd.print("Puntaje: ");
    lcd.print(puntaje);
    delay(1000);
  }

  if (ledOn && (millis() - ledStartTime > 2000)) {
    digitalWrite(ledPin, LOW);
    ledOn = false;
    topoCount++;

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Se escapo :(");
    lcd.setCursor(0, 1);
    lcd.print("Puntaje: ");
    lcd.print(puntaje);
    delay(1000);
  }
}
